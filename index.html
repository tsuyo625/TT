<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Open World</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body { width: 100%; height: 100%; background: #1a1a2e; overflow: hidden; }
      body { position: fixed; top: 0; left: 0; right: 0; bottom: 0; }
      canvas { display: block; width: 100% !important; height: 100% !important; touch-action: none; }

      /* Safe area for notched phones */
      @supports (padding: env(safe-area-inset-bottom)) {
        body { padding-bottom: env(safe-area-inset-bottom); }
      }

      /* Loading screen */
      #loading-screen {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(135deg, #1a2a1e 0%, #16312e 50%, #0f4630 100%);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 50; font-family: 'Segoe UI', sans-serif;
      }
      .loading-icon {
        width: 60px; height: 60px; border-radius: 50%;
        background: linear-gradient(135deg, #4a8f5c, #2d6b3f);
        margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(74, 143, 92, 0.5);
        animation: loadBounce 1.2s ease-in-out infinite;
        display: flex; align-items: center; justify-content: center;
        font-size: 28px;
      }
      @keyframes loadBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
      }
      .loading-title {
        font-size: 28px; font-weight: bold; color: #5cb85c;
        letter-spacing: 3px; margin-bottom: 8px;
      }
      .loading-dots {
        font-size: 16px; color: #a0c0a0;
      }
      .loading-dots::after {
        content: ''; animation: dots 1.5s steps(4, end) infinite;
      }
      @keyframes dots {
        0% { content: ''; }
        25% { content: '.'; }
        50% { content: '..'; }
        75% { content: '...'; }
      }
      #loading-error {
        display: none; margin-top: 24px; padding: 16px 24px;
        background: rgba(244, 67, 54, 0.15); border: 1px solid #f44;
        border-radius: 12px; max-width: 320px; text-align: center;
      }
      #loading-error-title {
        color: #f44; font-size: 16px; font-weight: bold; margin-bottom: 8px;
      }
      #loading-error-detail {
        color: #a0a0c0; font-size: 12px; line-height: 1.5; word-break: break-all;
      }
      #loading-retry {
        display: none; margin-top: 16px; padding: 12px 32px;
        background: #5cb85c; color: #fff; border: none; border-radius: 24px;
        font-size: 16px; font-weight: bold; cursor: pointer;
      }
    </style>
    <script>
    (function() {
      var panel = document.createElement('div');
      panel.id = 'debug-console';
      panel.style.cssText = 'position:fixed;bottom:0;left:0;right:0;height:35vh;background:rgba(0,0,0,0.92);color:#0f0;font:12px/1.4 monospace;overflow-y:auto;z-index:99999;padding:8px;display:none;border-top:2px solid #0f0;';
      var toggle = document.createElement('div');
      toggle.id = 'debug-toggle';
      toggle.textContent = 'DBG';
      toggle.style.cssText = 'position:fixed;bottom:8px;right:8px;width:44px;height:44px;background:#222;color:#0f0;border:2px solid #0f0;border-radius:50%;z-index:100000;display:flex;align-items:center;justify-content:center;font:bold 11px monospace;cursor:pointer;-webkit-tap-highlight-color:transparent;opacity:0.7;';
      var visible = false;
      toggle.addEventListener('click', function() {
        visible = !visible;
        panel.style.display = visible ? 'block' : 'none';
        toggle.style.opacity = visible ? '1' : '0.7';
        if (visible) panel.scrollTop = panel.scrollHeight;
      });
      function addLog(type, args) {
        var colors = { log: '#0f0', warn: '#ff0', error: '#f44', info: '#4af' };
        var time = new Date().toTimeString().slice(0, 8);
        var msg = Array.prototype.slice.call(args).map(function(a) {
          if (a instanceof Error) return a.message + '\n' + (a.stack || '');
          if (typeof a === 'object') try { return JSON.stringify(a, null, 1); } catch(e) { return String(a); }
          return String(a);
        }).join(' ');
        var entry = document.createElement('div');
        entry.style.cssText = 'color:' + (colors[type] || '#0f0') + ';border-bottom:1px solid #222;padding:3px 0;word-break:break-all;white-space:pre-wrap;';
        entry.textContent = '[' + time + ' ' + type.toUpperCase() + '] ' + msg;
        panel.appendChild(entry);
        if (visible) panel.scrollTop = panel.scrollHeight;
        if (type === 'error' && !visible) {
          visible = true; panel.style.display = 'block'; toggle.style.opacity = '1';
          panel.scrollTop = panel.scrollHeight;
        }
      }
      ['log', 'warn', 'error', 'info'].forEach(function(method) {
        var orig = console[method];
        console[method] = function() { orig.apply(console, arguments); addLog(method, arguments); };
      });
      window.addEventListener('error', function(e) { addLog('error', ['UNCAUGHT: ' + e.message + ' at ' + e.filename + ':' + e.lineno]); });
      window.addEventListener('unhandledrejection', function(e) { addLog('error', ['UNHANDLED: ' + (e.reason && e.reason.stack || e.reason)]); });
      document.addEventListener('DOMContentLoaded', function() { document.body.appendChild(panel); document.body.appendChild(toggle); });
      console.info('Debug console ready.');

      window.__MODULE_LOADED = false;
      setTimeout(function() {
        if (window.__MODULE_LOADED) return;
        console.error('Module failed to load within 8 seconds');
        var errBox = document.getElementById('loading-error');
        var retryBtn = document.getElementById('loading-retry');
        if (errBox) errBox.style.display = 'block';
        if (retryBtn) retryBtn.style.display = 'inline-block';
      }, 8000);
    })();
    </script>
  </head>
  <body>
    <div id="loading-screen">
      <div class="loading-icon">&#127758;</div>
      <div class="loading-title">Open World</div>
      <div class="loading-dots">読み込み中</div>
      <div id="loading-error">
        <div id="loading-error-title">読み込みエラー</div>
        <div id="loading-error-detail">スクリプトの読み込みに失敗しました</div>
      </div>
      <button id="loading-retry" onclick="location.reload()">リトライ</button>
    </div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
