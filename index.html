<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>缶けり KANKERI</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { background: #1a1a2e; overflow: hidden; }
      canvas { display: block; }

      /* Loading screen */
      #loading-screen {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 50; font-family: 'Segoe UI', sans-serif;
      }
      .loading-can {
        width: 50px; height: 70px; background: #ccc; border-radius: 8px;
        position: relative; margin-bottom: 24px;
        box-shadow: 0 4px 20px rgba(231, 76, 60, 0.5);
        animation: loadCanBounce 1.2s ease-in-out infinite;
      }
      .loading-can::after {
        content: ''; position: absolute; top: 25%; left: 0; right: 0;
        height: 30%; background: #e74c3c; border-radius: 4px;
      }
      @keyframes loadCanBounce {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        25% { transform: translateY(-20px) rotate(-5deg); }
        50% { transform: translateY(0) rotate(0deg); }
        75% { transform: translateY(-10px) rotate(3deg); }
      }
      .loading-title {
        font-size: 28px; font-weight: bold; color: #e94560;
        letter-spacing: 3px; margin-bottom: 8px;
      }
      .loading-dots {
        font-size: 16px; color: #a0a0c0;
      }
      .loading-dots::after {
        content: ''; animation: dots 1.5s steps(4, end) infinite;
      }
      @keyframes dots {
        0% { content: ''; }
        25% { content: '.'; }
        50% { content: '..'; }
        75% { content: '...'; }
      }
      #loading-error {
        display: none; margin-top: 24px; padding: 16px 24px;
        background: rgba(244, 67, 54, 0.15); border: 1px solid #f44;
        border-radius: 12px; max-width: 320px; text-align: center;
      }
      #loading-error-title {
        color: #f44; font-size: 16px; font-weight: bold; margin-bottom: 8px;
      }
      #loading-error-detail {
        color: #a0a0c0; font-size: 12px; line-height: 1.5; word-break: break-all;
      }
      #loading-retry {
        display: none; margin-top: 16px; padding: 12px 32px;
        background: #e74c3c; color: #fff; border: none; border-radius: 24px;
        font-size: 16px; font-weight: bold; cursor: pointer;
      }
    </style>
    <!-- Debug console + module load watchdog -->
    <script>
    (function() {
      // --- Debug console ---
      var panel = document.createElement('div');
      panel.id = 'debug-console';
      panel.style.cssText = 'position:fixed;bottom:0;left:0;right:0;height:35vh;background:rgba(0,0,0,0.92);color:#0f0;font:12px/1.4 monospace;overflow-y:auto;z-index:99999;padding:8px;display:none;border-top:2px solid #0f0;';

      var toggle = document.createElement('div');
      toggle.id = 'debug-toggle';
      toggle.textContent = 'DBG';
      toggle.style.cssText = 'position:fixed;bottom:8px;right:8px;width:44px;height:44px;background:#222;color:#0f0;border:2px solid #0f0;border-radius:50%;z-index:100000;display:flex;align-items:center;justify-content:center;font:bold 11px monospace;cursor:pointer;-webkit-tap-highlight-color:transparent;opacity:0.7;';

      var visible = false;
      toggle.addEventListener('click', function() {
        visible = !visible;
        panel.style.display = visible ? 'block' : 'none';
        toggle.style.opacity = visible ? '1' : '0.7';
        if (visible) panel.scrollTop = panel.scrollHeight;
      });

      function addLog(type, args) {
        var colors = { log: '#0f0', warn: '#ff0', error: '#f44', info: '#4af' };
        var time = new Date().toTimeString().slice(0, 8);
        var msg = Array.prototype.slice.call(args).map(function(a) {
          if (a instanceof Error) return a.message + '\n' + (a.stack || '');
          if (typeof a === 'object') try { return JSON.stringify(a, null, 1); } catch(e) { return String(a); }
          return String(a);
        }).join(' ');
        var entry = document.createElement('div');
        entry.style.cssText = 'color:' + (colors[type] || '#0f0') + ';border-bottom:1px solid #222;padding:3px 0;word-break:break-all;white-space:pre-wrap;';
        entry.textContent = '[' + time + ' ' + type.toUpperCase() + '] ' + msg;
        panel.appendChild(entry);
        if (visible) panel.scrollTop = panel.scrollHeight;
        if (type === 'error' && !visible) {
          visible = true;
          panel.style.display = 'block';
          toggle.style.opacity = '1';
          panel.scrollTop = panel.scrollHeight;
        }
      }

      ['log', 'warn', 'error', 'info'].forEach(function(method) {
        var orig = console[method];
        console[method] = function() {
          orig.apply(console, arguments);
          addLog(method, arguments);
        };
      });

      window.addEventListener('error', function(e) {
        addLog('error', ['UNCAUGHT: ' + e.message + ' at ' + e.filename + ':' + e.lineno + ':' + e.colno]);
      });
      window.addEventListener('unhandledrejection', function(e) {
        addLog('error', ['UNHANDLED PROMISE: ' + (e.reason && e.reason.stack || e.reason)]);
      });

      document.addEventListener('DOMContentLoaded', function() {
        document.body.appendChild(panel);
        document.body.appendChild(toggle);
      });

      console.info('Debug console ready. Tap DBG button to toggle.');
      console.info('URL: ' + location.href);

      // --- Module load watchdog ---
      window.__MODULE_LOADED = false;

      setTimeout(function() {
        if (window.__MODULE_LOADED) return;

        console.error('Module failed to load within 8 seconds');

        // Show error on loading screen
        var errBox = document.getElementById('loading-error');
        var errDetail = document.getElementById('loading-error-detail');
        var retryBtn = document.getElementById('loading-retry');
        if (errBox) errBox.style.display = 'block';
        if (retryBtn) retryBtn.style.display = 'inline-block';

        // Diagnose: try to fetch the script to check 404
        var scriptEl = document.querySelector('script[type="module"][src]');
        if (scriptEl) {
          var src = scriptEl.getAttribute('src');
          console.info('Script src: ' + src);
          console.info('Resolved URL: ' + new URL(src, location.href).href);

          fetch(src).then(function(res) {
            console.info('Script fetch status: ' + res.status + ' ' + res.statusText);
            console.info('Content-Type: ' + res.headers.get('content-type'));
            if (res.status === 404) {
              if (errDetail) errDetail.textContent = '404 Not Found: ' + src + '\nBase path mismatch?';
            } else if (res.ok) {
              // Script exists but module evaluation failed
              return res.text().then(function(text) {
                console.info('Script size: ' + text.length + ' bytes');
                if (errDetail) errDetail.textContent = 'Script loaded (' + text.length + 'B) but module evaluation failed. Check DBG console.';
              });
            } else {
              if (errDetail) errDetail.textContent = 'HTTP ' + res.status + ': ' + src;
            }
          }).catch(function(err) {
            console.error('Script fetch failed: ' + err.message);
            if (errDetail) errDetail.textContent = 'Network error: ' + err.message;
          });
        }
      }, 8000);
    })();
    </script>
  </head>
  <body>
    <!-- Loading screen (pure HTML, no JS dependency) -->
    <div id="loading-screen">
      <div class="loading-can"></div>
      <div class="loading-title">缶けり</div>
      <div class="loading-dots">読み込み中</div>
      <div id="loading-error">
        <div id="loading-error-title">読み込みエラー</div>
        <div id="loading-error-detail">スクリプトの読み込みに失敗しました</div>
      </div>
      <button id="loading-retry" onclick="location.reload()">リトライ</button>
    </div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
